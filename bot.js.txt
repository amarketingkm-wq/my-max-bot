// bot.js
require('dotenv').config(); // –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ .env
const { Bot } = require('@maxhub/max-bot-api');
const { addSubscriber, getAllSubscribers } = require('./database.js');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
const bot = new Bot(process.env.BOT_TOKEN);

// –í–∞—à ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (—Å—Ç—Ä–æ–∫–∞)
const ADMIN_ID = '48068949';

// === 1. –ö–û–ú–ê–ù–î–ê /start –ò –ö–ù–û–ü–ö–ê –ü–û–î–ü–ò–°–ö–ò ===
bot.command('start', async (ctx) => {
    const inlineKeyboard = [
        [{
            text: '‚úÖ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É',
            callback_data: 'subscribe'
        }]
    ];
    await ctx.reply('üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è.', {
        reply_markup: { inline_keyboard: inlineKeyboard }
    });
});

// === 2. –û–ë–†–ê–ë–û–¢–ö–ê –ù–ê–ñ–ê–¢–ò–Ø –ö–ù–û–ü–ö–ò "–ü–û–î–ü–ò–°–ê–¢–¨–°–Ø" ===
bot.on('message_callback', async (ctx) => {
    const query = ctx.callbackQuery;
    const userId = query.from.id.toString();

    if (query.data === 'subscribe') {
        const added = await addSubscriber(userId);
        // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
        await ctx.answerCallbackQuery({ text: added ? 'üéâ –í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å!' : '‚ÑπÔ∏è –í—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã.' });
        if (added) {
            await ctx.reply('‚úÖ –¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É.');
        }
    }
});

// === 3. –§–£–ù–ö–¶–ò–û–ù–ê–õ –†–ê–°–°–´–õ–ö–ò –î–õ–Ø –ê–î–ú–ò–ù–ê ===
// –û–±—ä–µ–∫—Ç –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ—Ç–æ–≤—è—â–µ–π—Å—è —Ä–∞—Å—Å—ã–ª–∫–µ
const pendingBroadcasts = {};

// 3.1. –ö–æ–º–∞–Ω–¥–∞ /send_all
bot.command('send_all', async (ctx) => {
    const userId = ctx.from.id.toString();

    if (userId !== ADMIN_ID) {
        return ctx.reply('‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.');
    }

    await ctx.reply('üìù *–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:*', { format: 'markdown' });
    // –°–æ–æ–±—â–∞–µ–º –±–æ—Ç—É, —á—Ç–æ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏
    pendingBroadcasts[userId] = { step: 'awaiting_text' };
});

// 3.2. –ü–µ—Ä–µ—Ö–≤–∞—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞ (—Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏)
bot.on('message_created', async (ctx) => {
    const userId = ctx.from.id.toString();
    const pending = pendingBroadcasts[userId];

    if (pending && pending.step === 'awaiting_text' && userId === ADMIN_ID) {
        const text = ctx.message?.body?.text;
        if (!text) {
            return ctx.reply('‚ùå –¢–µ–∫—Å—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞: /send_all');
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        pending.text = text;
        pending.step = 'awaiting_confirm';
        pendingBroadcasts[userId] = pending;

        const confirmKeyboard = [
            [{ text: '‚úÖ –î–ê, —Ä–∞–∑–æ—Å–ª–∞—Ç—å', callback_data: 'confirm_send' }],
            [{ text: '‚ùå –ù–ï–¢, –æ—Ç–º–µ–Ω–∏—Ç—å', callback_data: 'cancel_send' }]
        ];

        await ctx.reply(
            `üì¢ *–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É:*\n\n` +
            `–¢–µ–∫—Å—Ç: "${text.substring(0, 100)}${text.length > 100 ? '...' : ''}"\n\n` +
            `–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º?`,
            { reply_markup: { inline_keyboard: confirmKeyboard }, format: 'markdown' }
        );
    }
});

// 3.3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã —Ä–∞—Å—Å—ã–ª–∫–∏
bot.on('message_callback', async (ctx) => {
    const query = ctx.callbackQuery;
    const userId = query.from.id.toString();
    const pending = pendingBroadcasts[userId];

    if (query.data === 'confirm_send' && pending && pending.step === 'awaiting_confirm') {
        await ctx.answerCallbackQuery({ text: '–ù–∞—á–∏–Ω–∞—é —Ä–∞—Å—Å—ã–ª–∫—É...' });
        await ctx.reply('‚è≥ –†–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è...');

        const subscribers = await getAllSubscribers();
        let success = 0, fail = 0;

        for (const subId of subscribers) {
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –ø–æ–¥–ø–∏—Å—á–∏–∫—É
                await bot.api.sendMessageToUser(parseInt(subId), pending.text);
                success++;
                await new Promise(resolve => setTimeout(resolve, 200)); // –ü–∞—É–∑–∞, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è ${subId}:`, error.message);
                fail++;
            }
        }

        delete pendingBroadcasts[userId]; // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await ctx.reply(
            `üìä *–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!*\n‚úÖ –£—Å–ø–µ—à–Ω–æ: ${success}\n‚ùå –û—à–∏–±–æ–∫: ${fail}\nüì≠ –í—Å–µ–≥–æ –≤ –±–∞–∑–µ: ${subscribers.length}`,
            { format: 'markdown' }
        );
    }

    if (query.data === 'cancel_send') {
        delete pendingBroadcasts[userId];
        await ctx.answerCallbackQuery({ text: '–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.' });
        await ctx.reply('‚ùå –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
    }
});

// === –ó–ê–ü–£–°–ö –ë–û–¢–ê ===
bot.start().then(() => {
    console.log('ü§ñ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...');
}).catch((error) => {
    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:', error);
});